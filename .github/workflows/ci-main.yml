name: CI/CD Main Pipeline

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: üõ†Ô∏è Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: üêç Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: üì¶ Create Virtual Environment
      run: |
        python -m venv venv
        source venv/bin/activate
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV
        echo "$PWD/venv/bin" >> $GITHUB_PATH

    - name: üì• Install Dependencies
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install pytest pytest-cov pytest-asyncio
        pip install bandit safety flake8 black isort

    - name: üß™ Run Unit Tests with Coverage
      run: |
        source venv/bin/activate
        cd backend
        echo "Running unit tests from tests/unit/..."
        python -m pytest tests/unit/ \
          --cov=apps \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term \
          --junitxml=test-results.xml \
          -v
        if [ -f "coverage.xml" ]; then
          python -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('coverage.xml')
    cov = float(tree.getroot().attrib['line-rate']) * 100
    print(f'‚úÖ Test coverage: {cov:.1f}%')
except Exception as e:
    print(f'‚ö†Ô∏è Could not calculate coverage: {e}')
          "
        else
          echo "‚ö†Ô∏è No coverage.xml found (first run?)"
        fi
        echo "Note: Coverage requirement is disabled for initial setup"

    - name: üõ°Ô∏è Security Scanning
      run: |
        source venv/bin/activate
        echo "Running bandit security scan..."
        bandit -r backend/ \
          -f json \
          -o bandit-report.json \
          --severity-level high \
          --confidence-level high || echo "Bandit scan completed"
        echo "Running safety dependency scan..."
        safety check \
          --json \
          --output safety-report.json \
          --full-report || echo "Safety scan completed"
        echo "‚úÖ Security scans completed"

    - name: üìä Code Quality Analysis
      run: |
        source venv/bin/activate
        echo "Running code quality checks..."
        black --check --diff backend/ || echo "‚ö†Ô∏è Black formatting issues found"
        isort --check-only --diff backend/ || echo "‚ö†Ô∏è Import ordering issues found"
        flake8 backend/ \
          --max-line-length=100 \
          --extend-ignore=E203,W503 \
          --count \
          --statistics || echo "‚ö†Ô∏è Flake8 linting issues found"
        echo "‚úÖ Code quality checks completed"

    - name: üìù API Documentation Check
      run: |
        source venv/bin/activate
        echo "Checking API documentation..."
        if [ -f "openapi.json" ]; then
          python -c "
import json
try:
    with open('openapi.json') as f:
        doc = json.load(f)
    version = doc.get('info', {}).get('version', 'N/A')
    print(f'‚úÖ OpenAPI documentation found (Version: {version})')
except Exception as e:
    print(f'‚ö†Ô∏è OpenAPI documentation error: {e}')
          "
        else
          echo "‚ö†Ô∏è openapi.json not found"
        fi
        if [ -f "ci-cd/tests/check-essential-endpoints.py" ]; then
          echo "Running essential endpoints check..."
          python ci-cd/tests/check-essential-endpoints.py || echo "Endpoint check completed"
        fi

    - name: üíæ Database Schema Check
      run: |
        source venv/bin/activate
        echo "Checking database schema..."
        if [ -f "backend/core/database/setup.py" ]; then
          python backend/core/database/setup.py --check-migrations || echo "Migration check completed"
        fi
        if [ -f "ci-cd/scripts/test-db-connection.py" ]; then
          python ci-cd/scripts/test-db-connection.py || echo "Database connection test completed"
        fi

    - name: üì§ Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ github.run_id }}
        path: |
          backend/coverage.xml
          backend/test-results.xml
          backend/bandit-report.json
          backend/safety-report.json
          backend/htmlcov/
        retention-days: 30

    - name: üìä Generate Test Summary
      if: always()
      run: |
        echo "=== Test Execution Summary ==="
        echo "Workflow: $GITHUB_WORKFLOW"
        echo "Run ID: $GITHUB_RUN_ID"
        echo "Commit: $GITHUB_SHA"
        echo "Branch: $GITHUB_REF_NAME"
        date

    - name: üì¢ Send Notification
      if: always()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_TITLE: "CI/CD Pipeline - ${{ github.ref_name }}"
        SLACK_MESSAGE: "Pipeline ${{ job.status }} for commit ${{ github.sha }}"
        SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
      continue-on-error: true

  integration-tests:
    runs-on: ubuntu-latest
    needs: setup-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Run Integration Tests
      run: |
        echo "Integration tests would run here"
        echo "This job depends on setup-and-test job"
        echo "See integration-tests.yml for detailed integration tests"
        echo "‚úÖ Integration test placeholder completed"
    - name: Upload Integration Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-reports-${{ github.run_id }}
        path: |
          backend/test-results.xml
        retention-days: 30
